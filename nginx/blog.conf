# Nginx configuration for blog sites

upstream fruitionforestgarden {
    server fruitionforestgarden:3000;
}

upstream thetecnoagrarian {
    server thetecnoagrarian:3002;
}

# Main server block - redirect HTTP to HTTPS in production
server {
    listen 80;
    return 301 https://$host$request_uri;
}

# Fruition Forest Garden
server {
    listen 443 ssl http2;
    server_name fruitionforestgarden.com www.fruitionforestgarden.com;
    
    # SSL configuration (place your SSL certificates in nginx/ssl/)
    ssl_certificate /etc/nginx/ssl/fruitionforestgarden.crt;
    ssl_certificate_key /etc/nginx/ssl/fruitionforestgarden.key;
    
    location / {
        proxy_pass http://fruitionforestgarden;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Serve static files directly
    location /css/ {
        alias /var/www/fruitionforestgarden/public/css/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    location /js/ {
        alias /var/www/fruitionforestgarden/public/js/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    location /images/ {
        alias /var/www/fruitionforestgarden/public/images/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    location /uploads/ {
        alias /var/www/fruitionforestgarden/public/uploads/;
        expires 1y;
        add_header Cache-Control "public";
    }
}

# The Tecnoagrarian
server {
    listen 443 ssl http2;
    server_name thetecnoagrarian.com www.thetecnoagrarian.com;
    
    # SSL configuration
    ssl_certificate /etc/nginx/ssl/thetecnoagrarian.crt;
    ssl_certificate_key /etc/nginx/ssl/thetecnoagrarian.key;
    
    location / {
        proxy_pass http://thetecnoagrarian;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Serve static files directly
    location /css/ {
        alias /var/www/thetecnoagrarian/public/css/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    location /js/ {
        alias /var/www/thetecnoagrarian/public/js/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    location /images/ {
        alias /var/www/thetecnoagrarian/public/images/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    location /uploads/ {
        alias /var/www/thetecnoagrarian/public/uploads/;
        expires 1y;
        add_header Cache-Control "public";
    }
}
